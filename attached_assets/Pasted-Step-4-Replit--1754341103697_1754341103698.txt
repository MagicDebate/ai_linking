Step 4 «Импорт / Индексация» — функциональные требования
(всё, что Replit-бот должен реализовать, независимо от выбранного стека)

1. Точка входа
Событие	Что должно запуститься
Пользователь нажал «Сохранить и запустить импорт» в Step 3	• Создаётся Import Job с уникальным jobId.
• Wizard закрывается, пользователь перенаправляется на экран /project/{id}/import (далее «Экран прогресса»).

2. Бизнес-процесс «Import Job»
Фаза	Что делает воркер	Выходные данные (храним в БД)
2.1 Загрузка источника	• CSV / JSON: парсит файл.
• WP-push: принимает batched JSON.	pages_raw (url, raw_html, meta, importBatchId)
2.2 Boilerplate strip	Удаляет <nav>, <header>, <footer>, скрипты, стили.	pages_clean (clean_html, word_count)
2.3 Нарезка на блоки	Делит на <p>, <h2>, <h3> и сохраняет позицию.	blocks (page_id, block_type, text, position)
2.4 Извлечение метаданных	Title / H1 / Дата / Lang; TF-IDF / NER.	заполняет поля meta_* в БД
2.5 Эмбеддинг	Генерирует вектор для каждого блока (или всей страницы).	embeddings (block_id, vector)
2.6 Обновление графа	Строит / обновляет internal_link_graph (узлы=URL, рёбра=найденные ссылки).	глубина клика, in/out-degree, orphanFlag
2.7 Финал	Помечает importStatus = complete.	создаёт запись runImport с итоговой статистикой

Любая фаза при ошибке → job помечается failed, UI показывает alert с причинами.

3. Реaltime-коммуникация
Эндпоинт	Формат	Обязательное поведение
GET /api/import/status?projectId=	JSON poll или SSE / WS	{ percent, phase, pagesTotal, pagesDone, blocksDone, orphanCount }
Push-event «importLog»	текстовая строка	Отправляет 1–2 последние логи в UI-консоль

4. Экран прогресса (/project/{id}/import)
UI-элемент	Требование
Круговой или линейный прогресс-бар	обновляется минимум раз в 2 с; отражает percent
Состояние фазы	подпись «Скачиваем файлы → Чистим → Режем → Индексируем» (highlight текущей)
Карточка статистики	• страниц
• блоков
• orphan-URL
• средняя глубина клика
Консоль-логи (accordion)	последние 100 строк, автопрокрутка; кнопка «Скачать полный лог»
CTA	серый Generate links (disabled) → становится активным когда percent == 100
Кнопка «Отменить импорт»	ставит job в canceled, очищает неполные записи
Авто-refresh	при F5 состояние не теряется; за счёт importStatus в БД

5. Функции управления
Функция	Поведение
pause / resume (необяз.)	если пауза поддерживается очередью — остановить воркеры, потом продолжить
retry failed	при failed пользователь видит «Повторить» → перезапускаем с той же фазой
delete import batch	удаляет pages_raw/clean/blocks/embeddings у batchId; run не учитывается в метриках

6. Граничные условия и SLA
1 файл ≤ 250 MB; если больше — выдаём ошибку 413 Payload Too Large.

5 к одновременных страниц в обработке — лишние ставим в очередь.

Тайм-аут пакета — 2 ч; по истечении job → failed_time.

Ресетить прогресс-бар, если пользователь выбирает другой импорт-файл до завершения текущего.

7. Метрики (для будущего дашборда)
Метрика в БД	Считаем в конце импорта
pagesTotal	количество строк CSV / push
avgWordCount	среднее по word_count
deepPages	pages with clickDepth >= 5
orphanCount	inDegree == 0
importDuration	finishedAt - startedAt

Готовность Step 4 = пользователь в реальном времени видит, как импорт идёт до 100 %, получает статистику и может нажать «Generate links».