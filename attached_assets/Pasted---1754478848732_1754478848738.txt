Пользователь нажимает «Сгенерировать ссылки».

Система берёт текущие значения всех полей настроек — ровно те, что видны в форме (лимиты, каннибализация, Depth-Lift ON/OFF, и т. д.).

Если включён диалог «Область генерации», пользователь может дополнительно сузить набор страниц (паттерн URL, дата, доля выборки). После ОК эти фильтры прибавляются к параметрам.

Рабочий процесс одного Run-а
Создать runId, поставить статус running.

На экране показать линейный прогресс-бар; каждую секунду отправлять обновление phase / % / сгенерировано / отклонено.

Единственный цикл генерации проходит по всем страницам, попавшим в область запуска.

Для каждой пары «источник → цель» алгоритм формирует предложение ссылки.

Прежде чем сохранить кандидат, проверяет:
• не превышен Max links / page
• расстояние ≥ Min gap
• доля точных анкоров не превысит Exact-%
• нет дублирующей ссылки на тот же URL, если включён Remove duplicates
• фраза-анкор не входит в Stop-list
• страница-цель не конфликтует по каннибализации: если похожесть ≥ порог и политика = Block — кандидат отбрасывается; если Flag — помечается reason=cannibal_flag.

Параметры что именно генерировать определяются тем, какие «галки» включены в настройках (Orphan Fix, Head Consolidation, Depth Lift, Freshness Push, Cluster Cross, Commercial Routing). Если галка снята — соответствующий набор ссылок не формируется.

После цикла:

Если политика “404 links = Delete” — вычеркнуть все кандидаты, ведущие на 404.

Если “Replace” — найти ближайший живой URL и поменять цель.

К каждому новому <a> добавить класс, rel, target, если они заданы.

Записать все принятые кандидаты с отметкой draft.

Установить статус run draft; вернуть в UI событие finished=true.

Что отображается пользователю
Экран Draft Review открывается автоматически.

Есть фильтры по тегам (orphan, head, depth, fresh, cross, money, cannibal_flag).

Таблица показывает Source URL, Target URL, анкор и причину отклонения, если она есть.

Клик — всплывает diff-фрагмент «было / стало».

Если в настройке «Каноник = Manual» — дополнительно выводится список конкурирующих страниц для ручного выбора главной.